<html>
  <head>
    <title>Pay TODO change title</title>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/styles.css">
  </head>
  <body>
    <main>
      <div class="header">
        <img src="http://www.gravatar.com/avatar/meow.jpg?s=120&d=blank" id="userAvatar" class="avatar">
        <img src="/arrow.png" class="arrow">
        <img src="http://www.gravatar.com/avatar/<%= admin_hash %>.jpg?s=120" class="avatar">
      </div>
      <form action="/charge" method="POST">
        <label class="form-item">
          <input type="email" id="email" class="text-input" placeholder="Your Email">
        </label>
        <label class="form-item">
          <span>sends</span>
          <input type="text" id="amount" class="text-input" placeholder="Dollar Amount">
        </label>
        <label class="form-item">
          <span>for</span>
          <input type="text" id="reason" class="text-input" placeholder="Reason">
        </label>
        <label class="form-item">
          <button id="submitButton" class="disabled" disabled>Send Money to Robert</button>
        </label>
      </form>
      <div class="footer">
        Powered by <a href="https://github.com/lord/cashin">Cashin</a>
      </div>
    </main>
    <script src="http://code.jquery.com/jquery-2.1.4.js"></script>
    <script src="/md5.js"></script>
    <script src="https://checkout.stripe.com/checkout.js"></script>
    <script>
      $(function() {
        var getAmount = function() {
          var val = $('#amount').val();
          if (val[0] == "$") {
            val = val.substr(1);
          }
          if (isNaN(val)) {
            return false;
          } else {
            return Math.floor(val*100);
          }
        }

        var setEnabled = function($el, enable) {
          if (enable) {
            $el.attr('disabled', false).removeClass('disabled');
          } else {
            $el.attr('disabled', true).addClass('disabled');
          }
        };

        var handler = StripeCheckout.configure({
          key: 'pk_DD4UaTHeSAIiDGTU7pt106I4aJuEl',
          image: 'http://www.gravatar.com/avatar/<%= admin_hash %>.jpg?s=120',
          token: function(token) {
            setEnabled($('input, button, form'), false);
            $.ajax({
              type: "POST",
              url: '/charge',
              data: {
                stripeToken: token.id,
                stripeEmail: token.email,
                amount: getAmount()
              },
              success: function() {
                alert('yes!');
              },
              error: function() {
                alert('no!');
                setEnabled($('input, button, form'), true);
              }
            });
          }
        });

        $('#submitButton').on('click', function(e) {
          // Open Checkout with further options
          handler.open({
            name: 'Robert Lord',
            description: "For " + $("#reason").val(),
            amount: getAmount(),
            bitcoin: true,
            email: $("#email").val()
          });
          e.preventDefault();
        });

        // add $ on focus
        $('#amount').on('focus', function() {
          if ($(this).val() == "") {
            setTimeout(function() {
              $('#amount').val("$");
            }, 0);
          }
        });

        // remove $ on blur if no number
        $('#amount').on('blur', function() {
          if ($(this).val() == "$") {
            setTimeout(function() {
              $('#amount').val("");
            }, 0);
          }
        });

        $('input').on('change input', function() {
          setEnabled($('#submitButton'),
            getAmount() &&
            $('#amount').val() != "" &&
            $('#email').val() != "" &&
            $('#reason').val() != "");
        });

        $('#email').on('change input', function() {
          $("#userAvatar").attr("src","http://www.gravatar.com/avatar/" + md5($(this).val()) + ".jpg?s=120&d=blank");
        });

        // Close Checkout on page navigation
        $(window).on('popstate', function() {
          handler.close();
        });
      });
    </script>
  </body>
</html>
